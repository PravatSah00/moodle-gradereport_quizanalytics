define(["jquery","core/ajax"],function(t,a){return{analytic:function(){var e,s,n,i,l,d,o,r,c,p,u,f,h,m=[];Chart.plugins.register({beforeDraw:function(t){var a=t.chart.ctx;a.fillStyle="white",a.fillRect(0,0,t.chart.width,t.chart.height)}}),t(".viewanalytic").click(function(){var b=t(this).data("quiz_id");a.call([{methodname:"moodle_quizanalytics_analytic",args:{quizid:b}}])[0].done(function(a){if(a){var g=jQuery.parseJSON(a);p=g.allQuestions,b=g.quizid,u=g.url,h=g.lastUserQuizAttemptID,t(".showanalytics").find(".parentTabs").find("span.lastattemptsummary").hide(),t(".showanalytics").find("#tabs-1").find("p.lastattemptsummarydes").hide(),t(".showanalytics").find("#tabs-1").find("p.attemptsummarydes").show(),g.userAttempts>1&&(t(".showanalytics").find(".parentTabs").find("span.lastattemptsummary").show(),t(".showanalytics").find("#tabs-1").find("p.lastattemptsummarydes").show(),t(".showanalytics").find("#tabs-1").find("p.attemptsummarydes").hide()),setTimeout(function(){t(".showanalytics").find("ul.nav-tabs a").click(function(){if(t(this).tab("show"),480>t(window).width()){var a=t(".mobile_overflow"),e=t(".canvas-wrap");a.length>0&&a.scrollLeft((e.width()-a.width())/2)}})},100),t(".showanalytics").css("display","block"),1!=g.quizAttempt?(t("#tabs-2").find("ul").find("li").find("span.subtab1").show(),t("#tabs-2").find("ul").find("li").find("span.subtab2").hide(),t("#subtab21").find(".subtabmix").show(),t("#subtab21").find(".subtabtimechart").hide()):(t("#tabs-2").find("ul").find("li").find("span.subtab1").hide(),t("#tabs-2").find("ul").find("li").find("span.subtab2").show(),t("#subtab21").find(".subtabmix").hide(),t("#subtab21").find(".subtabtimechart").show()),m.length>0&&t.each(m,function(t,a){a.destroy()}),t(".attemptssnapshot").html(""),t.each(g.attemptssnapshot.data,function(a,e){var s=t.extend(g.attemptssnapshot.opt[a],{tooltips:{callbacks:{label:function(t,a){return" "+a.labels[t.index]+" : "+a.datasets[0].data[t.index]}}}});t(".attemptssnapshot").append('<div class="span6"><label><canvas id="attemptssnapshot'+a+'"></canvas><div id="js-legend'+a+'" class="chart-legend"></div></label><div class="downloadandshare"><a class="download-canvas" data-canvas_id="attemptssnapshot'+a+'"></a><div class="shareBtn" data-user_id="'+f+'" data-canvas_id="attemptssnapshot'+a+'"></div></div></div>');var n=document.getElementById("attemptssnapshot"+a).getContext("2d"),i=new Chart(n,{type:"doughnut",data:g.attemptssnapshot.data[a],options:s});document.getElementById("js-legend"+a).innerHTML=i.generateLegend(),t("#js-legend"+a).find("ul").find("li").on("click",function(a){var e=t(this).index();t(this).toggleClass("strike");var s=function t(a){for(var e in a)return a[e]}(attemptssSnapshot.config.data.datasets[0]._meta).data[e];s.hidden=!s.hidden,attemptssSnapshot.update()}),m.push(i)});var y=document.getElementById("questionpercat").getContext("2d");void 0!==l&&l.destroy();var v={tooltips:{callbacks:{label:function(t,a){return" "+a.labels[t.index]+" : "+a.datasets[0].data[t.index]}}}},$=t.extend(g.questionPerCategories.opt,v);l=new Chart(y,{type:"pie",data:g.questionPerCategories.data,options:$}),document.getElementById("js-legendqpc").innerHTML=l.generateLegend(),t("#js-legendqpc > ul > li").on("click",function(a){var e=t(this).index();t(this).toggleClass("strike");var s=function t(a){for(var e in a)return a[e]}(l.config.data.datasets[0]._meta).data[e];s.hidden=!s.hidden,l.update()});var v={tooltips:{custom:function(t){t&&(t.displayColors=!1)}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Hardest Categories"}}],yAxes:[{scaleLabel:{display:!0,labelString:"Hardness in percentage (%)"},ticks:{beginAtZero:!0,max:100,callback:function(t){if(Number.isInteger(t))return t}}}]}},$=t.extend(g.allUsers.opt,v),y=document.getElementById("allusers").getContext("2d");void 0!==i&&i.destroy(),i=new Chart(y,{type:"bar",data:g.allUsers.data,options:$});var v={tooltips:{custom:function(t){t&&(t.displayColors=!1)}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Hardest Categories"}}],yAxes:[{scaleLabel:{display:!0,labelString:"Hardness in percentage (%)"},ticks:{beginAtZero:!0,max:100,callback:function(t){if(Number.isInteger(t))return t}}}]}},$=t.extend(g.loggedInUser.opt,v),y=document.getElementById("loggedinuser").getContext("2d");if(void 0!==s&&s.destroy(),s=new Chart(y,{type:"bar",data:g.loggedInUser.data,options:$}),0!=g.lastAttemptSummary.data&&0!=g.lastAttemptSummary.opt){t(".showanalytics").find(".noquesisattempted").hide(),t(".showanalytics").find("#lastattemptsummary").show();var y=document.getElementById("lastattemptsummary");y.height=100;var x=y.getContext("2d");void 0!==e&&e.destroy();var v={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,a){return t.yLabel+" : "+t.xLabel},title:function(t,a){}}}},$=t.extend(g.lastAttemptSummary.opt,v);e=new Chart(x,{type:"horizontalBar",data:g.lastAttemptSummary.data,options:$})}else t(".showanalytics").find("#lastattemptsummary").hide(),t(".showanalytics").find("#lastattemptsummary").parent().append('<p class="noquesisattempted"><b>Please attempt at least one question.</b></p>');var v={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,a){return a.datasets[t.datasetIndex].label+" : "+t.yLabel},title:function(t,a){}}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Number of Attempts"}}],yAxes:[{scaleLabel:{display:!0,labelString:"Cut Off Score"},ticks:{beginAtZero:!0,callback:function(t){if(Number.isInteger(t))return t}}}]}},$=t.extend(g.mixChart.opt,v),y=document.getElementById("mixchart").getContext("2d");void 0!==n&&n.destroy(),n=new Chart(y,{type:"line",data:g.mixChart.data,options:$});var v={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,a){return t.yLabel+" : "+t.xLabel},title:function(t,a){}}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Score"},ticks:{beginAtZero:!0,callback:function(t){if(Number.isInteger(t))return t}}}]}},$=t.extend(g.timeChart.opt,v),y=document.getElementById("timechart").getContext("2d");void 0!==d&&d.destroy(),d=new Chart(y,{type:"horizontalBar",data:g.timeChart.data,options:$});var y=document.getElementById("gradeanalysis").getContext("2d");void 0!==o&&o.destroy();var v={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,a){return"Percentage Scored ("+a.labels[t.index]+") : "+a.datasets[0].data[t.index]}}}},$=t.extend(g.gradeAnalysis.opt,v);o=new Chart(y,{type:"pie",data:g.gradeAnalysis.data,options:$}),document.getElementById("js-legendgrade").innerHTML=o.generateLegend(),t("#js-legendgrade > ul > li").on("click",function(a){var e=t(this).index();t(this).toggleClass("strike");var s=function t(a){for(var e in a)return a[e]}(o.config.data.datasets[0]._meta).data[e];s.hidden=!s.hidden,o.update()});var y=document.getElementById("quesanalysis").getContext("2d");void 0!==r&&r.destroy();var v={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,a){return[a.datasets[t.datasetIndex].label+" : "+t.yLabel,"(Click to Review Question & Last Attempt)"]}}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Question Number"}}],yAxes:[{scaleLabel:{display:!0,labelString:"Number of Attempts"},ticks:{beginAtZero:!0,callback:function(t){if(Number.isInteger(t))return t}}}]}},$=t.extend(g.quesAnalysis.opt,v);r=new Chart(y,{type:"line",data:g.quesAnalysis.data,options:$});var v={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,a){return[a.datasets[t.datasetIndex].label+" : "+t.yLabel,"(Click to Review Question & Last Attempt)"]},title:function(t,a){}}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Hardest Questions"}}],yAxes:[{scaleLabel:{display:!0,labelString:"Number of Attempts"},ticks:{beginAtZero:!0,callback:function(t){if(Number.isInteger(t))return t}}}]}},$=t.extend(g.hardestQuestions.opt,v),y=document.getElementById("hardestques").getContext("2d");void 0!==c&&c.destroy(),c=new Chart(y,{type:"bar",data:g.hardestQuestions.data,options:$})}});var g=document.getElementById("quesanalysis");g&&(g.onclick=function(a){var e=r.getElementsAtEvent(a),s=e[0]._chart.config.data,n=e[0]._index,i=s.labels[n];if(void 0!==p){var l=0;t.each(p,function(t,a){if(i==a.split(",")[0]){var a=a.split(",")[1];if(0==l)var e=window.open(u+"/mod/quiz/review.php?attempt="+h+"&showall=0","","height=500,width=800");else var e=window.open(u+"/mod/quiz/review.php?attempt="+h+"&page="+l,"","height=500,width=800");return window.focus&&e.focus(),!1}l++})}});var y=document.getElementById("hardestques");y&&(y.onclick=function(a){var e=c.getElementsAtEvent(a),s=e[0]._chart.config.data,n=e[0]._index,i=s.labels[n];if(void 0!==p){var l=0;t.each(p,function(t,a){if(i==a.split(",")[0]){var a=a.split(",")[1];if(0==l)var e=window.open(u+"/mod/quiz/review.php?attempt="+h+"&showall=0","","height=500,width=800");else var e=window.open(u+"/mod/quiz/review.php?attempt="+h+"&page="+l,"","height=500,width=800");return window.focus&&e.focus(),!1}l++})}})}),t("#viewanalytic").one("click",function(){t(".showanalytics").find("canvas").each(function(){var a=t(this).attr("id");t(this).parent().append('<div class="downloadandshare"><a class="download-canvas" data-canvas_id="'+a+'"></a><div class="shareBtn" data-user_id="'+f+'" data-canvas_id="'+a+'"></div></div>')})}),t("body").on("click",".download-canvas",function(){var a,e,s,n=t(this).data("canvas_id");a=this,e=n,s=n+".jpeg",a.href=document.getElementById(e).toDataURL("image/jpeg"),a.download=s})}}});