define(["jquery","core/ajax"],function(t,e){return{analytic:function(){var a,s,n,i,l,d,o,r,c,p,u,f,m=[];Chart.plugins.register({beforeDraw:function(t){var e=t.chart.ctx;e.fillStyle="white",e.fillRect(0,0,t.chart.width,t.chart.height)}}),t(".viewanalytic").click(function(){var b=t(this).data("quiz_id");e.call([{methodname:"moodle_quizanalytics_analytic",args:{quizid:b}}])[0].done(function(e){var h=jQuery.parseJSON(e);if(h){p=h.allQuestions,b=h.quizid,u=h.url,f=h.lastUserQuizAttemptID,t(".showanalytics").find(".parentTabs").find("span.lastattemptsummary").hide(),t(".showanalytics").find("#tabs-1").find("p.attemptsummarydes").hide(),t(".showanalytics").find("#tabs-1").find("p.attemptsummarydes").show(),h.userAttempts>1&&(t(".showanalytics").find(".parentTabs").find("span.lastattemptsummary").show(),t(".showanalytics").find("#tabs-1").find("p.attemptsummarydes").show(),t(".showanalytics").find("#tabs-1").find("p.attemptsummarydes").hide()),setTimeout(function(){t(".showanalytics").find("ul.nav-tabs a").click(function(){if(t(this).tab("show"),480>t(window).width()){var e=t(".mobile-overflow"),a=t(".canvas-wrap");e.length>0&&e.scrollLeft((a.width()-e.width())/2)}})},100),t(".showanalytics").css("display","block"),1!=h.quizAttempt?(t("#tabs-2").find("ul").find("li").find("span.subtab1").show(),t("#tabs-2").find("ul").find("li").find("span.subtab2").hide(),t("#subtab21").find(".subtabmix").show(),t("#subtab21").find(".subtabtimechart").hide()):(t("#tabs-2").find("ul").find("li").find("span.subtab1").hide(),t("#tabs-2").find("ul").find("li").find("span.subtab2").show(),t("#subtab21").find(".subtabmix").hide(),t("#subtab21").find(".subtabtimechart").show()),m.length>0&&t.each(m,function(t,e){e.destroy()}),t(".attemptssnapshot").html(""),t.each(h.attemptssnapshot.data,function(e,a){var s=t.extend(h.attemptssnapshot.opt[e],{tooltips:{callbacks:{label:function(t,e){return" "+e.labels[t.index]+" : "+e.datasets[0].data[t.index]}}}});t(".attemptssnapshot").append('<div class="span6"><label><canvas id="attemptssnapshot'+e+'"></canvas><div id="js-legend'+e+'" class="chart-legend"></div></label><div class="download"><a class="download-canvas" data-canvas_id="attemptssnapshot'+e+'"></a></div></div>');var n=document.getElementById("attemptssnapshot"+e).getContext("2d"),i=new Chart(n,{type:"doughnut",data:h.attemptssnapshot.data[e],options:s});document.getElementById("js-legend"+e).innerHTML=i.generateLegend(),t("#js-legend"+e).find("ul").find("li").on("click",function(e){var a=t(this).index();t(this).toggleClass("strike");var s=function t(e){for(var a in e)return e[a]}(attemptssSnapshot.config.data.datasets[0]._meta).data[a];s.hidden=!s.hidden,attemptssSnapshot.update()}),m.push(i)});var g=document.getElementById("questionpercategories").getContext("2d");void 0!==l&&l.destroy();var y={tooltips:{callbacks:{label:function(t,e){return" "+e.labels[t.index]+" : "+e.datasets[0].data[t.index]}}}},v=t.extend(h.questionPerCategories.opt,y);l=new Chart(g,{type:"pie",data:h.questionPerCategories.data,options:v}),document.getElementById("js-legendqpc").innerHTML=l.generateLegend(),t("#js-legendqpc > ul > li").on("click",function(e){var a=t(this).index();t(this).toggleClass("strike");var s=function t(e){for(var a in e)return e[a]}(l.config.data.datasets[0]._meta).data[a];s.hidden=!s.hidden,l.update()});var y={tooltips:{custom:function(t){t&&(t.displayColors=!1)}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Hardest Categories"}}],yAxes:[{scaleLabel:{display:!0,labelString:"Hardness in percentage (%)"},ticks:{beginAtZero:!0,max:100,callback:function(t){if(Number.isInteger(t))return t}}}]}},v=t.extend(h.allUsers.opt,y),g=document.getElementById("allusers").getContext("2d");void 0!==i&&i.destroy(),i=new Chart(g,{type:"bar",data:h.allUsers.data,options:v});var y={tooltips:{custom:function(t){t&&(t.displayColors=!1)}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Hardest Categories"}}],yAxes:[{scaleLabel:{display:!0,labelString:"Hardness in percentage (%)"},ticks:{beginAtZero:!0,max:100,callback:function(t){if(Number.isInteger(t))return t}}}]}},v=t.extend(h.loggedInUser.opt,y),g=document.getElementById("loggedinuser").getContext("2d");if(void 0!==s&&s.destroy(),s=new Chart(g,{type:"bar",data:h.loggedInUser.data,options:v}),0!=h.lastAttemptSummary.data&&0!=h.lastAttemptSummary.opt){t(".showanalytics").find(".unattempted").hide(),t(".showanalytics").find("#lastattemptsummary").show();var g=document.getElementById("lastattemptsummary");g.height=100;var $=g.getContext("2d");void 0!==a&&a.destroy();var y={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,e){return t.yLabel+" : "+t.xLabel},title:function(t,e){}}}},v=t.extend(h.lastAttemptSummary.opt,y);a=new Chart($,{type:"horizontalBar",data:h.lastAttemptSummary.data,options:v})}else t(".showanalytics").find("#lastattemptsummary").hide(),t(".showanalytics").find("#lastattemptsummary").parent().append('<p class="unattempted"><b>Please attempt at least one question.</b></p>');var y={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,e){return e.datasets[t.datasetIndex].label+" : "+t.yLabel},title:function(t,e){}}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Number of Attempts"}}],yAxes:[{scaleLabel:{display:!0,labelString:"Cut Off Score"},ticks:{beginAtZero:!0,callback:function(t){if(Number.isInteger(t))return t}}}]}},v=t.extend(h.mixChart.opt,y),g=document.getElementById("mixchart").getContext("2d");void 0!==n&&n.destroy(),n=new Chart(g,{type:"line",data:h.mixChart.data,options:v});var y={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,e){return t.yLabel+" : "+t.xLabel},title:function(t,e){}}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Score"},ticks:{beginAtZero:!0,callback:function(t){if(Number.isInteger(t))return t}}}]}},v=t.extend(h.timeChart.opt,y),g=document.getElementById("timechart").getContext("2d");void 0!==d&&d.destroy(),d=new Chart(g,{type:"horizontalBar",data:h.timeChart.data,options:v});var g=document.getElementById("gradeanalysis").getContext("2d");void 0!==o&&o.destroy();var y={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,e){return"Percentage Scored ("+e.labels[t.index]+") : "+e.datasets[0].data[t.index]}}}},v=t.extend(h.gradeAnalysis.opt,y);o=new Chart(g,{type:"pie",data:h.gradeAnalysis.data,options:v}),document.getElementById("js-legendgrade").innerHTML=o.generateLegend(),t("#js-legendgrade > ul > li").on("click",function(e){var a=t(this).index();t(this).toggleClass("strike");var s=function t(e){for(var a in e)return e[a]}(o.config.data.datasets[0]._meta).data[a];s.hidden=!s.hidden,o.update()});var g=document.getElementById("questionanalysis").getContext("2d");void 0!==r&&r.destroy();var y={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,e){return[e.datasets[t.datasetIndex].label+" : "+t.yLabel,"(Click to Review Question & Last Attempt)"]}}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Question Number"}}],yAxes:[{scaleLabel:{display:!0,labelString:"Number of Attempts"},ticks:{beginAtZero:!0,callback:function(t){if(Number.isInteger(t))return t}}}]}},v=t.extend(h.quesAnalysis.opt,y);r=new Chart(g,{type:"line",data:h.quesAnalysis.data,options:v});var y={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,e){return[e.datasets[t.datasetIndex].label+" : "+t.yLabel,"(Click to Review Question & Last Attempt)"]},title:function(t,e){}}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Hardest Questions"}}],yAxes:[{scaleLabel:{display:!0,labelString:"Number of Attempts"},ticks:{beginAtZero:!0,callback:function(t){if(Number.isInteger(t))return t}}}]}},v=t.extend(h.hardestQuestions.opt,y),g=document.getElementById("hardest-questions").getContext("2d");void 0!==c&&c.destroy(),c=new Chart(g,{type:"bar",data:h.hardestQuestions.data,options:v})}});var h=document.getElementById("questionanalysis");h&&(h.onclick=function(e){var a=r.getElementsAtEvent(e),s=a[0]._chart.config.data,n=a[0]._index,i=s.labels[n];if(void 0!==p){var l=0;t.each(p,function(t,e){if(i==e.split(",")[0]){var e=e.split(",")[1];if(0==l)var a=window.open(u+"/mod/quiz/review.php?attempt="+f+"&showall=0","","height=500,width=800");else var a=window.open(u+"/mod/quiz/review.php?attempt="+f+"&page="+l,"","height=500,width=800");return window.focus&&a.focus(),!1}l++})}});var g=document.getElementById("hardest-questions");g&&(g.onclick=function(e){var a=c.getElementsAtEvent(e),s=a[0]._chart.config.data,n=a[0]._index,i=s.labels[n];if(void 0!==p){var l=0;t.each(p,function(t,e){if(i==e.split(",")[0]){var e=e.split(",")[1];if(0==l)var a=window.open(u+"/mod/quiz/review.php?attempt="+f+"&showall=0","","height=500,width=800");else var a=window.open(u+"/mod/quiz/review.php?attempt="+f+"&page="+l,"","height=500,width=800");return window.focus&&a.focus(),!1}l++})}})}),t("#viewanalytic").one("click",function(){t(".showanalytics").find("canvas").each(function(){var e=t(this).attr("id");t(this).parent().append('<div class="download"><a class="download-canvas" data-canvas_id="'+e+'"></a></div>')})}),t("body").on("click",".download-canvas",function(){var e,a,s,n=t(this).data("canvas_id");e=this,a=n,s=n+".jpeg",e.href=document.getElementById(a).toDataURL("image/jpeg"),e.download=s})}}});