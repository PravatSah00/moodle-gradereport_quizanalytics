define(["jquery","core/ajax"],function(t,a){return{analytic:function(e,s){var n,i,l,d,o,r,c,u,p,f,m,e,b,h=[];Chart.plugins.register({beforeDraw:function(t){var a=t.chart.ctx;a.fillStyle="white",a.fillRect(0,0,t.chart.width,t.chart.height)}}),t(".viewanalytic").click(function(){var s=t(this).data("quiz_id");a.call([{methodname:"moodle_quizanalytics_analytic",args:{quiz_id:s}}])[0].done(function(a){if(a){var y=jQuery.parseJSON(a);f=y.allquestion,s=y.quiz_id,m=y.url,b=y.lastuserquizattemptid,t(".showanalytics").find(".parentTabs").find("span.lastattemptsummary").hide(),t(".showanalytics").find("#tabs-1").find("p.lastattemptsummarydes").hide(),t(".showanalytics").find("#tabs-1").find("p.attemptsummarydes").show(),y.userattempts>1&&(t(".showanalytics").find(".parentTabs").find("span.lastattemptsummary").show(),t(".showanalytics").find("#tabs-1").find("p.lastattemptsummarydes").show(),t(".showanalytics").find("#tabs-1").find("p.attemptsummarydes").hide()),setTimeout(function(){t(".showanalytics").find("ul.nav-tabs a").click(function(){if(t(this).tab("show"),480>t(window).width()){var a=t(".mobile_overflow"),e=t(".canvas-wrap");a.length>0&&a.scrollLeft((e.width()-a.width())/2)}})},100),t(".showanalytics").css("display","block"),1!=y.quizattempt?(t("#tabs-2").find("ul").find("li").find("span.subtab1").show(),t("#tabs-2").find("ul").find("li").find("span.subtab2").hide(),t("#subtab21").find(".subtabmix").show(),t("#subtab21").find(".subtabtimechart").hide()):(t("#tabs-2").find("ul").find("li").find("span.subtab1").hide(),t("#tabs-2").find("ul").find("li").find("span.subtab2").show(),t("#subtab21").find(".subtabmix").hide(),t("#subtab21").find(".subtabtimechart").show()),h.length>0&&t.each(h,function(t,a){a.destroy()}),t(".attemptssnapshot").html(""),t.each(y.attemptssnapshot.data,function(a,s){var n=t.extend(y.attemptssnapshot.opt[a],{tooltips:{callbacks:{label:function(t,a){return" "+a.labels[t.index]+" : "+a.datasets[0].data[t.index]}}}});t(".attemptssnapshot").append('<div class="span6"><label><canvas id="attemptssnapshot'+a+'"></canvas><div id="js-legend'+a+'" class="chart-legend"></div></label><div class="downloadandshare"><a class="download-canvas" data-canvas_id="attemptssnapshot'+a+'"></a><div class="shareBtn" data-user_id="'+e+'" data-canvas_id="attemptssnapshot'+a+'"></div></div></div>');var i=document.getElementById("attemptssnapshot"+a).getContext("2d"),l=new Chart(i,{type:"doughnut",data:y.attemptssnapshot.data[a],options:n});document.getElementById("js-legend"+a).innerHTML=l.generateLegend(),t("#js-legend"+a).find("ul").find("li").on("click",function(a){var e=t(this).index();t(this).toggleClass("strike");var s=l,n=function t(a){for(var e in a)return a[e]}(s.config.data.datasets[0]._meta).data[e];n.hidden=!n.hidden,s.update()}),h.push(l)});var g=document.getElementById("questionpercat").getContext("2d");void 0!==o&&o.destroy();var v=t.extend(y.questionpercat.opt,{tooltips:{callbacks:{label:function(t,a){return" "+a.labels[t.index]+" : "+a.datasets[0].data[t.index]}}}});o=new Chart(g,{type:"pie",data:y.questionpercat.data,options:v}),document.getElementById("js-legendqpc").innerHTML=o.generateLegend(),t("#js-legendqpc > ul > li").on("click",function(a){var e=t(this).index();t(this).toggleClass("strike");var s=o,n=function t(a){for(var e in a)return a[e]}(s.config.data.datasets[0]._meta).data[e];n.hidden=!n.hidden,s.update()});var $=t.extend(y.all_users.opt,{tooltips:{custom:function(t){t&&(t.displayColors=!1)}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Hardest Categories"}}],yAxes:[{scaleLabel:{display:!0,labelString:"Hardness in percentage (%)"},ticks:{beginAtZero:!0,max:100,callback:function(t){if(Number.isInteger(t))return t}}}]}}),g=document.getElementById("allusers").getContext("2d");void 0!==d&&d.destroy(),d=new Chart(g,{type:"bar",data:y.all_users.data,options:$});var x=t.extend(y.loggedin_user.opt,{tooltips:{custom:function(t){t&&(t.displayColors=!1)}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Hardest Categories"}}],yAxes:[{scaleLabel:{display:!0,labelString:"Hardness in percentage (%)"},ticks:{beginAtZero:!0,max:100,callback:function(t){if(Number.isInteger(t))return t}}}]}}),g=document.getElementById("loggedinuser").getContext("2d");if(void 0!==i&&i.destroy(),i=new Chart(g,{type:"bar",data:y.loggedin_user.data,options:x}),0!=y.last_attempt_summary.data&&0!=y.last_attempt_summary.opt){t(".showanalytics").find(".noquesisattempted").hide(),t(".showanalytics").find("#lastattemptsummary").show();var g=document.getElementById("lastattemptsummary");g.height=100;var w=g.getContext("2d");void 0!==n&&n.destroy();var k=t.extend(y.last_attempt_summary.opt,{tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,a){return t.yLabel+" : "+t.xLabel},title:function(t,a){}}}});n=new Chart(w,{type:"horizontalBar",data:y.last_attempt_summary.data,options:k})}else t(".showanalytics").find("#lastattemptsummary").hide(),t(".showanalytics").find("#lastattemptsummary").parent().append('<p class="noquesisattempted"><b>Please attempt at least one question.</b></p>');var L=t.extend(y.mixchart.opt,{tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,a){return a.datasets[t.datasetIndex].label+" : "+t.yLabel},title:function(t,a){}}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Number of Attempts"}}],yAxes:[{scaleLabel:{display:!0,labelString:"Cut Off Score"},ticks:{beginAtZero:!0,callback:function(t){if(Number.isInteger(t))return t}}}]}}),g=document.getElementById("mixchart").getContext("2d");void 0!==l&&l.destroy(),l=new Chart(g,{type:"line",data:y.mixchart.data,options:L});var _=t.extend(y.timechart.opt,{tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,a){return t.yLabel+" : "+t.xLabel},title:function(t,a){}}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Score"},ticks:{beginAtZero:!0,callback:function(t){if(Number.isInteger(t))return t}}}]}}),g=document.getElementById("timechart").getContext("2d");void 0!==r&&r.destroy(),r=new Chart(g,{type:"horizontalBar",data:y.timechart.data,options:_});var g=document.getElementById("gradeanalysis").getContext("2d");void 0!==c&&c.destroy();var q=t.extend(y.gradeanalysis.opt,{tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,a){return"Percentage Scored ("+a.labels[t.index]+") : "+a.datasets[0].data[t.index]}}}});c=new Chart(g,{type:"pie",data:y.gradeanalysis.data,options:q}),document.getElementById("js-legendgrade").innerHTML=c.generateLegend(),t("#js-legendgrade > ul > li").on("click",function(a){var e=t(this).index();t(this).toggleClass("strike");var s=c,n=function t(a){for(var e in a)return a[e]}(s.config.data.datasets[0]._meta).data[e];n.hidden=!n.hidden,s.update()});var g=document.getElementById("quesanalysis").getContext("2d");void 0!==u&&u.destroy();var C=t.extend(y.quesanalysis.opt,{tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,a){return[a.datasets[t.datasetIndex].label+" : "+t.yLabel,"(Click to Review Question & Last Attempt)"]}}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Question Number"}}],yAxes:[{scaleLabel:{display:!0,labelString:"Number of Attempts"},ticks:{beginAtZero:!0,callback:function(t){if(Number.isInteger(t))return t}}}]}});u=new Chart(g,{type:"line",data:y.quesanalysis.data,options:C});var I=t.extend(y.hardestques.opt,{tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,a){return[a.datasets[t.datasetIndex].label+" : "+t.yLabel,"(Click to Review Question & Last Attempt)"]},title:function(t,a){}}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:"Hardest Questions"}}],yAxes:[{scaleLabel:{display:!0,labelString:"Number of Attempts"},ticks:{beginAtZero:!0,callback:function(t){if(Number.isInteger(t))return t}}}]}}),g=document.getElementById("hardestques").getContext("2d");void 0!==p&&p.destroy(),p=new Chart(g,{type:"bar",data:y.hardestques.data,options:I})}});var y=document.getElementById("quesanalysis"),g=document.getElementById("hardestques");y&&(y.onclick=function(a){var e=u.getElementsAtEvent(a),s=e[0]._chart.config.data,n=e[0]._index,i=s.labels[n];void 0!==f&&t.each(f,function(t,a){if(i==a.split(",")[0]){var a=a.split(",")[1],e=window.open(m+"/mod/quiz/review.php?attempt="+b+"&page="+a,"","height=500,width=800");return window.focus&&e.focus(),!1}})}),g&&(g.onclick=function(a){var e=p.getElementsAtEvent(a),s=e[0]._chart.config.data,n=e[0]._index,i=s.labels[n];void 0!==f&&t.each(f,function(t,a){if(i==a.split(",")[0]){var a=a.split(",")[1],e=window.open(m+"/mod/quiz/review.php?attempt="+b+"&page="+a,"","height=500,width=800");return window.focus&&e.focus(),!1}})})}),t("#viewanalytic").one("click",function(){t(".showanalytics").find("canvas").each(function(){var a=t(this).attr("id");t(this).parent().append('<div class="downloadandshare"><a class="download-canvas" data-canvas_id="'+a+'"></a><div class="shareBtn" data-user_id="'+e+'" data-canvas_id="'+a+'"></div></div>')})}),t("body").on("click",".download-canvas",function(){var a,e,s,n=t(this).data("canvas_id");a=this,e=n,s=n+".jpeg",a.href=document.getElementById(e).toDataURL("image/jpeg"),a.download=s})}}});